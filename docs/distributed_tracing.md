# 分散トレーシング

## 概要

クエストに対して動作するマイクロサービスの処理状況をログとして送信・保存することで、リクエスト全体の流れを可視化するシステムのことを指します。
今回はスタンダードなOpenTelmetryを利用した分散トレーシングを実装。

### 役割

1. トレース (Trace):
   - 分散システムやマイクロサービス環境でリクエスト全体の流れを追跡したい場合。
   - どのサービスが遅延しているのか、エラーが発生しているのかを特定。

2. スパン (Span):
   - トレースの一部として、個別操作（データベースクエリや外部API呼び出し）の詳細を分析したい場合。

3. メトリクス (Metrics):
   - システムのパフォーマンスや状態を監視し、スケーリングやアラートに活用。
   - CPU、メモリ、エラー率など、継続的な監視が必要なケース。

| **項目**         | **トレース (Trace)**                          | **スパン (Span)**                           | **メトリクス (Metrics)**                     |
|-------------------|----------------------------------------------|--------------------------------------------|---------------------------------------------|
| **単位**         | リクエスト全体の流れ                         | リクエスト内の個別操作                      | システムやアプリのパフォーマンス指標          |
| **例**           | ユーザーがページをロードする                 | データベースクエリ、API呼び出し             | CPU使用率、エラー率、リクエスト数             |
| **構成**         | 複数のスパンで構成される                     | トレースの構成要素                          | 時系列データ                                  |
| **主な用途**     | システム全体のリクエストフローの可視化         | 特定操作の詳細な分析                        | リソース使用状況やパフォーマンス監視          |
| **情報の性質**   | リクエスト間の相関性やフローを追跡           | 操作単位の詳細データ                        | システム全体の状態や傾向                     |
| **時間の粒度**   | リクエストの開始から終了                     | 操作単位の時間 (ミリ秒やマイクロ秒単位)      | 継続的な収集（秒単位など）                   |

---

## 実装内容

ミドルウェアとGORMのコールバックを通してログを取得している。
ここでの注意点として、web socket等のリアルタイム通信で頻繁にリクエストがされる場合、ミドルウェアを通るとCloudWatchやCloud Logging等のモニタリングサービスに対して大量のリクエストが飛んでしまい負荷がかかる可能性があるので取り扱いには注意。

スタブのAWSモジュールでも同様にトレーサーを配置しログを取るようにしている。


## 参考

Spanなどの作り込みが用途に合わせて重要になってくるその際はドキュメントの以下のページを参考にするとよい

- [https://opentelemetry.io/docs/concepts/semantic-conventions/](https://opentelemetry.io/docs/concepts/semantic-conventions/)

例
- [HTTP](https://opentelemetry.io/docs/specs/semconv/http/http-spans/)
- [データベース](https://opentelemetry.io/docs/specs/semconv/attributes-registry/db/)




